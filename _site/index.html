<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; I'm just sayin!</title>
<meta name="description" content="Describe this nonsense.">
<meta name="keywords" content="Jekyll, theme, themes, responsive, blog, modern">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/abstract-1.jpg">

<meta name="twitter:title" content="Latest Posts">
<meta name="twitter:description" content="Describe this nonsense.">
<meta name="twitter:creator" content="@jdg_8">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="Describe this nonsense.">
<meta property="og:url" content="/">
<meta property="og:site_name" content="I'm just sayin!">





<link rel="canonical" href="/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="I'm just sayin! Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/avatar.jpg" alt="John Griffith photo" class="author-photo">
					<h4>John Griffith</h4>
					<p>Software Developer (among other things) enjoys new technologies and talking with others about them.</p>
				</li>
				<li><a href="/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:john.griffith8@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/jdg_8"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				<li>
					<a href="https://google.com/john.griffith8@gmail.com"><i class="fa fa-fw fa-google-plus"></i> Google+</a>
				</li>
				
				<li>
					<a href="https://github.com/j-griffith"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="/theme-setup/" >Theme Setup</a></li>
	  
	    
	    <li><a href="http://mademistakes.com" target="_blank">External Link</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  <div class="image-credit">Image source: <a href="http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/">dargadgetz</a></div><!-- /.image-credit -->
  
    <div class="entry-image">
      <img src="/images/abstract-1.jpg" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>I'm just sayin!</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-09-07T00:00:00-06:00"><a href="/cinder-providing-block-storage-for-more-than-just-nova/">September 07, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About John Griffith">John Griffith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~13 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/cinder-providing-block-storage-for-more-than-just-nova/" rel="bookmark" title="Cinder - Block Storage for things other than Nova" itemprop="url">Cinder - Block Storage for things other than Nova</a></h1>
    
  </header>
  <div class="entry-content">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<h1 id="cinder-as-storage-for-docker-part-1-of-2">Cinder as storage for Docker (part 1 of 2)</h1>

<p>A lot of you may be familiar with Cinder, the OpenStack Block Storage project that’s been around for quite a while now.  If you’re not, you should take a look at the series of blog posts my friend <a href="https://cloudarchitectmusings.com/">Ken Hui</a> at Rackspace put together, <a href="http://blog.rackspace.com/laying-cinder-block-volumes-in-openstack-part-1-the-basics">Laying Cinder Block</a>.  That’s a more detailed version of the presentation he and I gave at the Summit in Atlanta a couple years back.</p>

<p>The context most think of when they consider Cinder is always “Block Storage for Nova Instances”.  The fact is however that it’s pretty useful outside of the traditional Nova context.  You can use Cinder as a powerful “Block Storage as a Service” resource for a number of use cases and environments.  Myself and a few other have been doing this for a number of years now, mostly with Bare Metal systems in our labs.</p>

<p>Given that Containers are the hottest thing since sliced bread these days, I thought it would be fun to post a little how to on how to use Cinder by itself with Containers.  For those of you that saw my presentation at the OpenStack Summit in Austin last spring, here’s what I was trying to show you on stage when I lost my wifi connection.</p>

<p>On that note, here’s part 1 of a 2 part posting about using Cinder a little bit differently than you may have been doing previously.</p>

<h2 id="a-neat-use-case-that-works-for-me">A neat use case that works for me</h2>

<p>So one pattern that I’ve found myself using more and more that’s kind of interesting is that my development is a bit mixed.  Some times I’m doing things on an OpenStack Instance, other times on a workstation or bare metal server, and more recently working in Containers (ok, and sometimes public cloud… but we’ll let the one slide for now).</p>

<p>What I found was that I could use my Cinder deployment (by itself, or as part of a full OpenStack deployment) to manage my storage needs across all three models fairly easily.  Even better, I could start working on something in one environment, and easily take my data with me to another.  I’ve now dones this with some build images and data base files not just from my workstation to a Nova Instance, but also now to Docker Containers.  As I change my app to run in various environments I just unplug the storage and plug it back in where I want it.  Kinda cool right?</p>

<h2 id="cinder-doesnt-know-or-care-whos-consuming-it-mostly">Cinder doesn’t know or care who’s consuming it (mostly)</h2>

<p>The biggest point of all of this is that for the most part, Cinder doesn’t know (or care) who or what is calling it’s API or even really what they’re doing with the resources.  It’s mostly just a control plane to bridge the differences between various backend storage devices.  What a caller chooses to do with those resources is up to them, and it doesn’t really matter if that’s a person using the respponse data to type in info on a cmd line, an automation script on a bare metal server, or in our case today a Docker Volume Plugin.</p>

<p>I will reluctantly point out that over the years there have been some things that have crept into the code that make Cinder a bit more Nova aware (which is unfortunate) but it’s still pretty easy to work around.  Most of it is just things like requiring Instance UUID’s for attach (that’s a failry generic thing though) and also there are some backends that have snuck in some <em>features</em> that use Nova to help them out.  In this case today I’m focused on just using the LVM driver and iSCSI connectivity.  This also works for other iSCSI based backends including SolidFire and others.</p>

<h2 id="a-cinder-plugin-for-docker">A Cinder plugin for Docker</h2>

<p>Containers are hot, no doubt about it.  They’re useful, the provide some pretty awesome flexibility in terms of not only development, but more importantly are fanstastic when it comes to deployment.  So, while I’ve been using Cinder against my Bare Metal systems and OpenStack Cloud for a while, last fall I started doing more and more with Containers, so I decided it would be worthwhile to write a <a href="https://github.com/j-griffith/cinder-docker-driver">Cinder Plugin for Docker</a> that would allow me to use Cinder directly.</p>

<h3 id="yes-this-has-been-done-before">Yes, this has been done before</h3>

<p>So the first thing people pointed out was that “you can do this already”.  Yup, that’s true (ish), there are a number of offerings in the Container space that have created plugins for Docker that run on top of and consume Cinder.  Some fo them even work (some of them don’t).  None of them have much involvement from the Cinder community, and none of them are completely Cinder focused.</p>

<p>Anyway, that’s all great, if you use one of those (or choose to use one in the future) good for you!  That’s awesome, but if you are looking for something that is “just” Cinder and is not maintained by a storage vendor maybe this will be of interest to you.</p>

<p><em>Disclosure</em> Yes, I work for SolidFire/Netapp.  There’s no underlying interest here for me though other than Cinder and cool tech.  If you know me from the community I’m pretty good at keeping company and community interests seperate.  I’m also fortunate enough to work for some great folks that <em>get it</em> and understand the importance.</p>

<h3 id="docker-volume-plugins">Docker Volume Plugins</h3>

<p>Docker started offering a Volume API a few releases back, it’s actually really pretty simple.  You can read up on it a bit <a href="https://docs.docker.com/engine/extend/plugins_volume/">here</a> if you’re interested.</p>

<p>The key here is that it’s pretty simple, and that’s a good… no that’s a <em>GREAT</em> thing.  You’ll notice if you poke around on that link that there are quite a few volume plugins available.  You also might notice that several of the devices listed out there also have Cinder plugins/drivers.</p>

<h2 id="the-cinder-plugin">The Cinder plugin</h2>
<p>All of the plugins are pretty similar in how they work, the majority of us choose to use golang and the now official Docker Plugins Helper module.  Between that and the awesome <a href="https://github.com/rackspace/gophercloud">Gophercloud</a> golang bindings for OpenStack started by RackSpace, creating the plugin was pretty easy.  The only effort here was the addition of some code to do the attach/detach of the Cinder volumes, even that though is still pretty trivial.  I just added some open-iscsi wrappers to the plugin and voila.</p>

<p><em>warning</em> I’ve only implemented iSCSI.. because; well it’s my favorite.  Those that offer other options are more than welcome to submit PR’s if they’re interested.</p>

<p>Here are some of the reasons for creating this plugin rather than just pointing to and using someone elses:
1. I happen to consider myself a bit of a Cinder expert
2. Vendor agnostic (my Github repo is mine)
3. I’m focused on just Cinder that’s it (other variants have other motivations)
4. Licenesed under the Unlicense so you don’t have to be afraid to contribute, sign a EULA etc.  (but please don’t start submitting stuff with copyright headers etc)</p>

<h3 id="lets-get-started">Let’s get started</h3>
<p>##### Pre Requisites</p>

<p>For Ubuntu:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install open-iscsi
</code></pre>
</div>

<p>For RHEL variants:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo yum install iscsi-initiator-utils
</code></pre>
</div>

<p>Of course make sure you have Docker installed, I recommend 1.12 at this point.</p>

<p>Currently the plugin is a simple daemon written in Golang.  You’ll need to isntall it on your Docker Node(s), edit a simple config file to point it to your Cinder Endpoint and fire it up.  I’ve recently created a systemd init service for this that the install script will create and set everything up for you.  So all you have to do is use curl, or wget and pull down the install script and run it as root (or with sudo)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>curl -sSL https://raw.githubusercontent.com/j-griffith/cinder-docker-driver/master/install.sh \
| sudo sh
</code></pre>
</div>

<p>Next we just set up a minimal config file so we can talk to our Cinder Endpoint (standard OpenStack stuff here), we’ll just create a json file with the needed credential info <code class="highlighter-rouge">/var/lib/cinder/dockerdriver/config.json</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="w">    </span><span class="p">{</span><span class="w">
        </span><span class="nt">"HostUUID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"82ee38eb-821b-42d0-8c61-c4974d0c8536"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"Endpoint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://172.16.140.243:5000/v2.0"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"Username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jdg"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"Password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NotMyPassword"</span><span class="p">,</span><span class="w">
        </span><span class="nt">"TenantID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3dce5dd10b414ac1b942aba8ce8558e7"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p>Now, if you’ve used the install script you can just start the service:
<code class="highlighter-rouge">sudo service cinder-docker-driver restart</code></p>

<p>Verify everything came up properly:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo service cinder-docker-driver status
● cinder-docker-driver.service - "Cinder Docker Plugin daemon"
   Loaded: loaded (/etc/systemd/system/cinder-docker-driver.service; enabled; vendor preset: enabled)
   Active: active (running) since Thu 2016-09-08 23:44:06 UTC; 29min ago
 Main PID: 13917 (cinder-docker-d)
    Tasks: 6
   Memory: 5.3M
      CPU: 290ms
   CGroup: /system.slice/cinder-docker-driver.service
           └─13917 /usr/bin/cinder-docker-driver &amp;

Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=debug msg="getVolByName: `cvol-4`"
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=debug msg="querying volume: {Attachments:[] AvailabilityZone:nova Bootable:false ConsistencyGroupID: CreatedAt:2016-09-08T23:46:13.000000 Description:Docker volume. Encrypted:false Name:cvol-4 VolumeType:lvmdriver-1 ReplicationDriverData: ReplicationE
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=debug msg="Found Volume ID: 677a821b-e33b-44b5-8fb3-38315e832216"
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=info msg="Remove/Delete Volume: cvol-4"
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=debug msg="getVolByName: `cvol-4`"
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=debug msg="querying volume: {Attachments:[] AvailabilityZone:nova Bootable:false ConsistencyGroupID: CreatedAt:2016-09-08T23:46:13.000000 Description:Docker volume. Encrypted:false Name:cvol-4 VolumeType:lvmdriver-1 ReplicationDriverData: ReplicationE
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=debug msg="Found Volume ID: 677a821b-e33b-44b5-8fb3-38315e832216"
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=debug msg="Remove/Delete Volume ID: 677a821b-e33b-44b5-8fb3-38315e832216"
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:46:59Z" level=debug msg="Response from Delete: {ErrResult:{Result:{Body:&lt;nil&gt; Header:map[] Err:&lt;nil&gt;}}}\n"
Sep 08 23:47:07 box-1 cinder-docker-driver[13917]: time="2016-09-08T23:47:07Z" level=info msg="List volumes: "
lines 1-20/20 (END)
</code></pre>
</div>
<p>Then you can use journalctl to filter out the relative entries in syslog:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">ubuntu@box-1:~$ </span>journalctl -f -u cinder-docker-driver
-- Logs begin at Thu 2016-09-08 20:52:15 UTC. --
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">"getVolByName: </span><span class="sb">`</span>cvol-4<span class="sb">`</span><span class="s2">"</span>
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">"querying volume: {Attachments:[] AvailabilityZone:nova Bootable:false ConsistencyGroupID: CreatedAt:2016-09-08T23:46:13.000000 Description:Docker volume. Encrypted:false Name:cvol-4 VolumeType:lvmdriver-1 ReplicationDriverData: ReplicationExtendedStatus: ReplicationStatus:disabled SnapshotID: SourceVolID: Status:available TenantID:979ddb6183834b9993954ca6de518c5a Metadata:map[readonly:False] Multiattach:false ID:677a821b-e33b-44b5-8fb3-38315e832216 Size:1 UserID:e763fc47a2854b15a9f6b85aea2ae3f1}</span><span class="se">\n</span><span class="s2">"</span>
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">"Found Volume ID: 677a821b-e33b-44b5-8fb3-38315e832216"</span>
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">"Remove/Delete Volume: cvol-4"</span>
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">"getVolByName: </span><span class="sb">`</span>cvol-4<span class="sb">`</span><span class="s2">"</span>
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">"querying volume: {Attachments:[] AvailabilityZone:nova Bootable:false ConsistencyGroupID: CreatedAt:2016-09-08T23:46:13.000000 Description:Docker volume. Encrypted:false Name:cvol-4 VolumeType:lvmdriver-1 ReplicationDriverData: ReplicationExtendedStatus: ReplicationStatus:disabled SnapshotID: SourceVolID: Status:available TenantID:979ddb6183834b9993954ca6de518c5a Metadata:map[readonly:False] Multiattach:false ID:677a821b-e33b-44b5-8fb3-38315e832216 Size:1 UserID:e763fc47a2854b15a9f6b85aea2ae3f1}</span><span class="se">\n</span><span class="s2">"</span>
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">"Found Volume ID: 677a821b-e33b-44b5-8fb3-38315e832216"</span>
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">"Remove/Delete Volume ID: 677a821b-e33b-44b5-8fb3-38315e832216"</span>
Sep 08 23:46:59 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:46:59Z"</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">"Response from Delete: {ErrResult:{Result:{Body:&lt;nil&gt; Header:map[] Err:&lt;nil&gt;}}}</span><span class="se">\n</span><span class="s2">"</span>
Sep 08 23:47:07 box-1 cinder-docker-driver[13917]: <span class="nb">time</span><span class="o">=</span><span class="s2">"2016-09-08T23:47:07Z"</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">"List volumes: "</span>
</code></pre>
</div>

<p>That’s about it, the plugin should get picked up by your Docker Daemon and be ready to accept requests.  Couple of things to look out for:</p>

<ol>
  <li>
    <p>You have to use V2.0 as your endpoint for now, GopherCloud chose to implement extensions (like Attach) as versioned items instead of extensions which is what they currently are.   Discovery works as long as it ends up being V2.0, but V1 or V3 won’t work.  Microversioning support is going to create some consumer issues here I think but we’ll cross that bridge when we come to it.</p>
  </li>
  <li>
    <p>If you get weird error messages on startup about username and/or TenantID it’s almost always an issue with your TenantID so start there</p>
  </li>
  <li>
    <p>It never hurts to restart the Docker Daemon on your node after you install the Plugin just to be safe</p>
  </li>
  <li>
    <p>We expect/look for the config.json file in /var/lib/cinder/dockerdriver/ but you can specifiy this with the –config flag.</p>
  </li>
</ol>

<h4 id="using-the-plugin-via-docker">Using the Plugin via Docker</h4>

<p>So that’s about it as far as install and setup.  Now you can access your Cinder service from the Docker volume API.  This means you can do things like use the Docker Volumes CLI to do things, as well as add Volume arguments to your Docker run commands and even your compose file.</p>

<h5 id="docker-volume-cli">Docker Volume CLI</h5>

<div class="highlighter-rouge"><pre class="highlight"><code>$ docker volume --help

Usage:     docker volume COMMAND

Manage Docker volumes

Options:
      --help   Print usage

Commands:
  create      Create a volume
  inspect     Display detailed information on one or more volumes
  ls          List volumes
  rm          Remove one or more volumes

Run 'docker volume COMMAND --help' for more information on a command.
</code></pre>
</div>

<p>Let’s look at a simple create example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ docker volume create -d cinder -o size=1 --name demovol

</code></pre>
</div>

<p>Now list using Dockers API:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ docker volume ls
DRIVER              VOLUME NAME
cinder              demovol
</code></pre>
</div>

<p>Cool.. how about checking with Cinder:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cinder list

+--------------------------------------+-----------+---------+------+-------------+----------+-------------+
| ID                                   | Status    | Name    | Size | Volume Type | Bootable | Attached to |
+--------------------------------------+-----------+---------+------+-------------+----------+-------------+
| 21a42614-c381-4bbc-b1d0-8498014f2d65 | available | demovol | 1    | lvmdriver-1 | false    |             |
+--------------------------------------+-----------+---------+------+-------------+----------+-------------+
$
</code></pre>
</div>
<p>I know, I know.. big deal, we can create a volume.</p>

<p>Let’s try something a little more interesting; let’s spin up a container and specify a volume to be created at the same time, we can do this using the Docker Run command, or via a Dockerfile.</p>

<h5 id="docker-run-command">Docker Run command</h5>

<p>Syntax to add a persistent storage volume to your conatiner at launch.  Notice that the Plugin will first check to see if the Volume already exists or not, if it does NOT it will create it for you using the info provided or defaults, if it does exist it will just do the attach and mount for you.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ docker run -v demovol-2:/Data --volume-driver=cinder -i -t ubuntu /bin/bash
$ cinder list

+--------------------------------------+-----------+-----------+------+-------------+----------+--------------------------------------+
| ID                                   | Status    | Name      | Size | Volume Type | Bootable | Attached to                          |
+--------------------------------------+-----------+-----------+------+-------------+----------+--------------------------------------+
| 08c0c2af-4f91-4488-82a7-96bd020e8c00 | in-use    | demovol-2 | 1    | lvmdriver-1 | false    | 969bd5f5-64e3-433e-a248-04c3f7899a45 |
| 21a42614-c381-4bbc-b1d0-8498014f2d65 | available | demovol   | 1    | lvmdriver-1 | false    |                                      |
+--------------------------------------+-----------+-----------+------+-------------+----------+--------------------------------------+
$

</code></pre>
</div>

<p>So now you’ll have Cinder volume (demovol-2) mounted and formatted with ext4 at /Data inside your container.</p>

<h5 id="docker-compose">docker-compose</h5>

<p>I like compose, automation is bestest….</p>

<div class="highlighter-rouge"><pre class="highlight"><code>web:
  environment:
    - "reschedule:on-node-failure"
    - "constraint:node!=swarm-master"
  image: jgriffith/jgriffith-webbase
  ports:
     - "80:80"
  links:
    - "redis:redis"
redis:
  environment:
    - "reschedule:on-node-failure"
  image: redis
  volumes:
    - "demovol:/data"
  volume_driver: cinder
</code></pre>
</div>

<h2 id="conclusion">Conclusion</h2>
<p>So these are pretty trivial examples, but it’s pretty easy to extend these examples into more <em>complex</em> builds.  I’ve been using this setup for a while now to host a number of things ranging from a <a href="https://github.com/vmware/harbor">Harbor Docker Registry</a> (images and DB backed by seperate cinder-volumes and running on a Nova Instance).  Other simple things are backing for a Redis store that I use as a simple message queue for a CI system I run, and another application I have where I’m running a Redis DB container that is persisting it’s data to a Cinder volume.  There’s quite a few things in my lab using Cinder now, some of those things are Nova Instances, but more and more of them lately are something else.</p>

<p>The key take away here however is that Cinder is a lot more flexible than people might think.  It doesn’t have any real hard dependencies on Nova, Glance etc. It’s just about managing a pool of storage via the control plane and it leaves it up to the consumer to connect it however/wherever it wants.</p>

<p>I’d love to hear your feedback, and try and answer any questions you might have.  Thanks for reading!</p>

<h2 id="next-time">Next time</h2>

<p>You can also use this with Swarm, coming up next we’ll go through how you can quickly and easily deploy a Swarm cluster on your OpenStack cloud and use the Cinder driver to keep persistent data in your Swarm Cluster and automatically move the volume across nodes in failover scenarios.  In the meantime, if you’re interested check it out, feel free to suggest improvements, raise issues or submit PRs.</p>

<p>Before you ask… Kubernetes is very different.  It doesn’t actually use Docker’s Volume API, and with the exception of some experimental code in the different Cloud Provider drivers it also doesn’t do things like dynamic provisioning (create volumes).  It’s a completely different animal, and does things it’s own way.  TLDR if you’re using Kubernetes, this doesn’t really buy you anything.</p>

<p>If you want more info on why this, and not some of the existing projects (including Kuryr) I’m happy to provide my opinions…  Thanks!!</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2016-02-12T09:51:33-07:00"><a href="/2016/02/12/openstack-cinders-reference-implementation/">February 12, 2016</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About John Griffith">John Griffith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~6 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/2016/02/12/openstack-cinders-reference-implementation/" rel="bookmark" title="<span data-rel="title">OpenStack Cinders reference implementation</span>" itemprop="url"><span data-rel="title">OpenStack Cinders reference implementation</span></a></h1>
    
  </header>
  <div class="entry-content">
    <p><span data-rel="content"></span></p>

<p>
  As many are fully aware, over the years I&#8217;ve had pretty strong opinions about good and bad things in the OpenStack Cinder project.  Let&#8217;s be clear, most of the &#8220;bad&#8221; are criticisms against myself and how things evolved than they are about the project or the people contributing to it.
</p>

<p>
  Lately there&#8217;s been a resurgence of the &#8220;LVM as a reference implementation&#8221; discussion due to a comment I made on twitter about one off vendor features being in the Cinder API.  This created quite the buzz, ranging from &#8220;LVM sucks&#8221; to &#8220;Criticism doesn&#8217;t help the project&#8221;.  All of that aside, I wanted to point a few things out for people to think about on this topic.
</p>

<p>
  First, keep in mind the purpose of a &#8220;reference&#8221; implementation.  The WHOLE point of a reference implementation is to provide a reference for people to use in development.  LVM has been the reference because it most closely fits the model that other backend-devices use.  In particular iSCSI targets attached to LVM volumes, in my opinion provides a really flexible and dynamic transport/connect mechanism in a cloud environment.  Some argue that things like NFS are better.. and maybe in some cases that&#8217;s true, but the original design and architecture in OpenStack was to provide Block Storage, so in that context iSCSI was a pretty cheap and flexible way to go about it.  I&#8217;d also point out that iSCSI and networking in general have come a VERY long way in the last 5+ years!  This isn&#8217;t your old iSCSI where people were trying to attach storage over a 1G WAN and shockingly had &#8220;issues&#8221;.
</p>

<p>
  So, what&#8217;s wrong with LVM?  Well, if you ask me the only thing wrong with it is that the OpenStack community only has a very few people that are really interested in paying any attention to it.  There was a comment last week to the effect that &#8220;using LVM as a reference implementation makes me sad&#8221;, my response was &#8220;why&#8221;?  There seems to be a misconception that there are things LVM can&#8217;t do that other OSS products can (in a Cinder context), but I&#8217;ve yet to figure out what those things are?  If you look at the code on Github and do a check between features in LVM and features in other OSS drivers you won&#8217;t find &#8220;missing&#8221; API calls.  Of course, have fun trying to figure out the structure with the whole feature-class thing going on in the base driver to link things together and figure out what&#8217;s actually real and what&#8217;s not (I&#8217;ll save that whole topic for another day&#8230; or just keep it between me and the Cinder community).
</p>

<p>
  The point is, this statement that &#8220;LVM is bad because it can&#8217;t do things&#8221; is just plain false.  There&#8217;s no Cinder API feature that it&#8217;s not capable of, the only exception to this is some of the custom one-off API calls that have been added specifically for one or two proprietary vendors that nobody was creative enough, or spent the time or effort on to implement in the LVM driver.  We used to have a *rule* that if you wanted to add a new feature or API call to Cinder, you had to FIRST implement it in the LVM driver.  Over time however Cinder grew, and folks decided this wasn&#8217;t such a big deal, and there should be exceptions.  So some vendors were allowed to add their own custom things.  The result, API calls in Cinder that may or may not work, and nobody EVER spending the time to go back and implement them in the Reference/LVM driver.  What&#8217;s also very telling here for me is to point out that these features that I was complaining about are NOT available in the other Open Source drivers either, Ceph included.  I&#8217;d also continue to assert as I have that the ONLY thing lacking with the LVM driver is interest from developers and the perpetual off-handed comments by people who don&#8217;t actually even know anything about how LVM works or the things that can be done with it.  Rather than say &#8220;LVM sucks&#8221;, maybe you should educate yourself on LVM a bit more and write some cinder/volume/drivers/lvm.py code.  I&#8217;ll admit, it requires a bit more effort than some other backends, and you certainly have to be creative.. but that&#8217;s the fun part.
</p>

<p>
  That brings me to my next point.  There&#8217;s been a few snarky comments about Ceph as the reference implementation.  Even better, there&#8217;s been some suggestions that &#8220;Vendors are thwarting this&#8221;, I find this almost as hilarious as I find it sad.  I&#8217;ve actually proposed the topic to a number of folks over the years, including at the Summit in Paris on a public panel with Sage Weil (creator and overall Ceph GURU).  The overwhelming response was &#8220;probably not a good idea&#8221;.  The reason for most folks that had that opinion was because Ceph is VERY different than any other storage backend.  In terms of a reference, it doesn&#8217;t necessarily help other technologies (iSCSI being predominant) .  Now, let me also say it again publicly and very clearly, I think Ceph is AWESOME, as do a lot of people deploying OpenStack.  It is not however the ONLY option.  If we wanted to deliver a product instead of a framework then yes, that might be what we&#8217;d want to consider.  The fact is though, we (OpenStack) are pretty explicit that we are NOT delivering a product, but we ARE building a framework.  I&#8217;d also point out that there are a lot of use cases out there, and there is no one product/backend that meets all of them.  There are very few large deployments these days that only have a single backend for Cinder.  Yes, I know there are exceptions here, but I&#8217;m saying &#8220;majority&#8221;.
</p>

<p>
  So where are we now?  Well, given where we are now maybe we should revisit this.  Here&#8217;s why; it turns out that earlier on a number of vendors didn&#8217;t follow the reference implementation anyway.  They either didn&#8217;t understand how it worked, didn&#8217;t care or didn&#8217;t like it.  So a number of the methods in the internal API do &#8220;different&#8221; things (or nothing) depending on the driver.  The problem with this is that then, a new developer comes along and wants to implement a driver.  They happen to notice Vendor-X&#8217;s driver does things a certain way that seems to align with their product so they use it as a template.  Now we have another driver that&#8217;s diverged.  Then the next developer comes along&#8230; he/she ends up taking some pieces from one driver, combined with some pieces from another driver that somebody in IRC worked on and pointed to in order to answer some questions.  What you end up with is inconsistency across all the drivers and a very tangled mess.  Remember what I said about criticism earlier?  Well, this is something that I criticize myself for.  As the person that started Cinder and the PTL for the first few years I should have caught these disparities in reviews and made sure they were fixed up.  I also should&#8217;ve made the reference cleaner and more clear so that there wouldn&#8217;t be questions about it.  I also should&#8217;ve continued my objections via -2&#8217;s for adding API methods that were NOT in the reference implementation.  Lessons learned, and that&#8217;s where the comments I&#8217;ve made on twitter came from over the past week.
</p>

<p>
  <em><strong>I&#8217;m all for revisiting the topic of Cinder&#8217;s reference implementation, BUT do me a favor; if you&#8217;re going to participate please do some homework.  Make sure you at least have a general idea of what the capabilities, use cases and problems we&#8217;re trying to solve are.  Also, ask the question, are we &#8220;building a reference, or a default&#8221;, because they&#8217;re not necessarily the same thing.</strong></em>
</p>

<p>
  &nbsp;
</p>
<p>&lt;/span&gt;</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2015-07-16T10:00:00-06:00"><a href="/volume-attach-code-flow-in-cinder/">July 16, 2015</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About John Griffith">John Griffith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~6 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/volume-attach-code-flow-in-cinder/" rel="bookmark" title="Volume attach code flow in Cinder" itemprop="url">Volume attach code flow in Cinder</a></h1>
    
  </header>
  <div class="entry-content">
    <br /><br /><br /><header class="entry-header" style="box-sizing: border-box; color: #444444; font-family: Merriweather, Georgia, 'Times New Roman', serif; font-size: 18px; line-height: 30px;"><h1 class="entry-title" style="border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-size: 2.61111em; font-style: inherit; font-weight: inherit; line-height: 1.26383em; margin: 30px 0px; outline: 0px; padding: 0px; text-align: center; vertical-align: baseline;">OpenStack Cinder – Volume Attach&nbsp;flow</h1></header><br /><div class="entry-content" style="border: 0px; box-sizing: border-box; font-family: Merriweather, Georgia, 'Times New Roman', serif; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><h2 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 29px; font-style: inherit; font-weight: inherit; line-height: 1.02414em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">Intro</span></h2><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">Something that comes up fairly often in IRC, is “how does attach work”? &nbsp;From a Cinder perspective the code path is fairly simple, but it seems to throw people for a loop. &nbsp;So, I figured why not take a look at the reference implementation and walk through the steps of volume attach from the Cinder side.</div><h2 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 29px; font-style: inherit; font-weight: inherit; line-height: 1.02414em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">Our Reference</span></h2><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">The Cinder project includes a reference driver, so we’ll use that as our reference here to walk through the code. &nbsp;The reference driver is built in Cinder using a combination of LVM and iSCSI targets (tgt-adm or LIO most commonly). &nbsp;As with everything in OpenStack you have choices, we’re just going to focus on the default options here, thick provisioned LVM and TgtAdm for the iSCSI component. &nbsp;We’re also using the default libvirt/KVM config on our Nova side.</div><h2 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 29px; font-style: inherit; font-weight: inherit; line-height: 1.02414em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">A few high level details</span></h2><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">It’s important to understand that most of the work with respect to attaching a volume is done on the Nova side. &nbsp;Cinder is mostly just responsible for providing a volumes information to Nova so that it can make an iSCSI attach on the Compute Node.</div><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">The communication path between Nova and Cinder is done via the cinderclient, the same cinderclient a command line user accesses; however Nova uses a special policy that allows it to access some details about a volume that regular users can’t, as well as a few calls you might not have seen before.</div><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">So what we’re going to do is look at an OpenStack deployment that has a volume ready to go (available) and an Instance that’s up and ready. &nbsp;We’ll focus on the calls from Nova to Cinder and Cinders response. &nbsp;In a follow up post we’ll dig into what’s happening on the Nova side.</div><h2 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 29px; font-style: inherit; font-weight: inherit; line-height: 1.02414em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">Process flow</span></h2><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">As I mentioned, things on the Cinder side are rather simple. &nbsp;The attach process is just&nbsp;three&nbsp;calls to Cinder:</div><ol style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin: 0px 0px 30px 30px; outline: 0px; padding: 0px; vertical-align: baseline;"><li style="border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">reserve_volume</li><li style="border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">intialize_connection</li><li style="border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">attach</li></ol><h3 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 23px; font-style: inherit; font-weight: inherit; line-height: 1.2913em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">reserve_volume(self, context, volume)</span></h3><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;"><em style="border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">context: security/policy info for the request</span></em><br /><em style="border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">volume: reference object of the volume being requested for reserve</span></em></div><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">Probably the most simple call&nbsp;in to Cinder. &nbsp;This method simply checks that the specified volume is in an “available” state and can be attached. &nbsp;Any other state results in an Error response notifying Nova that the volume is NOT available. &nbsp;The only valid state for this call to succeed is “available”.</div><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">If the volume is in fact available, we immediately issue an update to the Cinder database and mark the status of the volume to “attaching” thereby reserving the volume so that it won’t be used by another API call anywhere else.</div><h3 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 23px; font-style: inherit; font-weight: inherit; line-height: 1.2913em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">initialize_connection(self, context, volume, connector)</span></h3><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><em style="border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">context: security/policy info for the request</em></span><br /><span style="border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><em style="border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">volume: reference object of the volume being requested for reserve<br style="box-sizing: border-box;" />connector: information about the initiator if needed (ie targets that use access groups etc)</em></span></div><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;">This is the only Cinder API method that really has any significant work to do, and it’s the only one that really has any real interaction with the storage backend or driver. &nbsp;This method is responsible for building and returning all of the info needed by Nova to actually attach the specified volume. &nbsp;This method returns vital information to the caller (Nova) that includes things like CHAP credentials, iqn and lun information. &nbsp;An example response is shown here:<br /><br /></div><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">{‘driver_volume_type': ‘iscsi’,</span><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; ‘data': {‘auth_password': ‘YZ2Hceyh7VySh5HY’,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘target_discovered': False,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘encrypted': False,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘qos_specs': None,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘target_iqn': ‘iqn.2010-10.org.openstack:volume-8b1ec3fe-8c5</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘target_portal': ‘11.0.0.8:3260′,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘volume_id': ‘8b1ec3fe-8c57-45ca-a1cf-a481bfc8fce2′,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘target_lun': 1,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘access_mode': ‘rw’,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘auth_username': ‘nE9PY8juynmmZ95F7Xb7′,</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‘auth_method': ‘CHAP’}}</span><br /><span style="border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><br /></span></div><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;">In the process of building this data structure, the Cinder manager makes a number of direct calls to the driver. &nbsp;The manager itself has a single initialize_connection call of it's own, but ties together a number of driver calls from within that method. &nbsp;<span style="font-family: inherit; font-style: inherit; font-weight: inherit;">&nbsp;&nbsp;</span></div><h3 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="font-size: small;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="color: #ff6600; line-height: 1.2913em;">&nbsp; &nbsp; &nbsp; &nbsp; </span><span style="color: #ff6600; line-height: 1.2913em;">driver.validate_connector</span><br /><span style="color: #ff6600; line-height: 1.2913em;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="font-weight: normal;"> &nbsp; </span></span><span style="font-weight: normal;"><span style="line-height: 1.2913em;">Simply verifies that the initiator data is included in the passed in&nbsp;</span><span style="line-height: 24.1731357574463px;"><br /></span></span></span><span style="font-weight: normal;"><span style="font-family: inherit; font-style: inherit; line-height: 24.1731357574463px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-family: inherit; font-style: inherit; line-height: 1.2913em;">connector (there are some drivers that utilize pieces of this connector<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data, but in the case of the reference, it just verifies it's there).&nbsp;</span></span></span></h3><div><h3 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="font-size: small;"><span style="color: #ff6600; line-height: 1.2913em;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color: #ff6600; line-height: 1.2913em;">driver.create_export</span><br /><span style="color: #ff6600; line-height: 1.2913em;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-weight: normal; line-height: 1.2913em;">This is the target specific, persistent data associated with a volume.<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; This method is responsible for building an actual iSCSI target, and<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; providing the "location" and "auth" information which will be used to<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form the response data in the parent request.<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; We call this infor the model_update and it's used to update vital target<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; information associated with the volume in the Cinder database.</span></span></span></h3></div><div><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"></span><br /><h3 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="font-size: small;"><span style="color: #ff6600; line-height: 1.2913em;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color: #ff6600; line-height: 1.2913em;">driver.intialize_connection</span><br /><span style="color: #ff6600; line-height: 1.2913em;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style="font-weight: normal; line-height: 1.2913em;">Now that we've actually built a target and persisted the important<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bits of information associated with it, we're ready to actually assign<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the target to a volume and form the needed info to pass back out<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to our caller. &nbsp;This is where we finally put everything together and<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; form the example data structure response shown earlier.</span></span></span></span></h3><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"></span><br /><h3 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="font-size: small;"><span style="font-weight: normal; line-height: 1.2913em;"><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; This method is sort of deceptive, it does a whole lot of formatting<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of the data we've put together in the create_export call, but it doesn't<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; really offer any new info. &nbsp;It's completely dependent on the information<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that was gathered in the create_export call and put into the database. &nbsp;At<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this point, all we're doing is taking all the various entries from the database<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and putting it together into the desired format/structure.</span></span></span></span></h3><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"></span><div><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="font-size: small;"><span style="line-height: 1.2913em;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The key method call for updating and obtaining all of this info was<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; done by the create_export call. &nbsp;This formatted data is then passed<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; back up to the API and returned as the response back out to Nova.</span></span></span></span><br /><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="font-size: small;"><span style="line-height: 1.2913em;"><br /></span></span></span></span></div><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><div><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="font-size: small;"><span style="line-height: 1.2913em;">At this point Nova can use the returned info and actually make the iSCSI attach on the compute node, and then pass the volume into the requested Instance. &nbsp;If there are no errors, the volume is now actually attached to the Instance as a /dev/vdX device and ready for use. &nbsp;Remember however there was still one Cinder call left in our list: &nbsp;attach.</span></span></span></div><div><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="font-size: small;"><span style="line-height: 1.2913em;"><br /></span></span></span></div><div><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"></span><br /><h3 style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 23px; font-style: inherit; font-weight: inherit; line-height: 1.2913em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">attach(</span></span><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">self, context, volume,&nbsp;</span></span><span style="color: #ff6600; font-style: inherit; font-weight: inherit;">instance_uuid, host_name,<br />mount_point, mode)</span></h3><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"></span><br /><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><em style="border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">context: security/policy info for the request</em></span></span><br /><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><em style="border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">volume: reference object of the volume being requested for reserve<br style="box-sizing: border-box;" />instance_uuid: UUID of the Nova instance we've attached to<br />host_name: N/A for the reference driver<br />mount_point: device mount point on the instance (/dev/vdb)<br />mode: The attach mode of the Volume (rw, ro etc)</em></span></span></div><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"></span><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;"><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">This is another method that falls into a category I call "update methods". &nbsp;It's purpose is to notify Cinder to update the status of the volume to "in-use" (attached) and to populate the database with the provided information regarding "where" it's attached to. &nbsp;</span></div><span style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;">This also provides a mechanism to send notifications and updates back to the driver. &nbsp;</div><div style="border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;"><span style="border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><em style="border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><br /></em></span></div></span></div></span></div></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2014-12-08T00:00:00-07:00"><a href="/openstack-live-migration-with-cinder-backed-instances/">December 08, 2014</a></time></span><span class="author vcard"><span class="fn"><a href="/about/" title="About John Griffith">John Griffith</a></span></span>
      
      <span class="entry-reading-time">
        <i class="fa fa-clock-o"></i>
        
Reading time ~8 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="/openstack-live-migration-with-cinder-backed-instances/" rel="bookmark" title="OpenStack Live Migration With Cinder Backed Instances" itemprop="url">OpenStack Live Migration With Cinder Backed Instances</a></h1>
    
  </header>
  <div class="entry-content">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<p>Over the last several weeks I keep getting questions about Live Migration, does it work, how do you configure it, what are the requirements to use it and so on.  To be honest up until recently I hadn’t actually dove into Live Migration so I tried it out (and failed), then started asking around and resorting to Google Searches.  The good thing is, there’s TONS of information out there, problem is, there’s TONS of information out there.  The bad thing here is the info isn’t all that consistent.  Like many things there’s always more than one way to achieve an end result, Live Migration is really no different.  So I thought I’d try and write up what worked for me and in my opinion was the simplest method to use.</p>

<p>First off, for those that aren’t familiar; Live Migration of OpenStack Instances is the process of migrating an OpenStack Instance from one Compute Node to another with little or no downtime.  The docs page has a good description here: <a href="http://docs.openstack.org/admin-guide-cloud/content/section_configuring-compute-migrations.html">OpenStack Admin-Guide</a></p>

<p>One of the big misconceptions about Live Migration is that if you’re Instances aren’t stored on a Shared FS or a Shared backend device like CEPH you can’t do Live-Migration.  That’s not true at all, in fact notice the doc has an entry specifically for Volume-Backed Instances.  So let’s take a look at how to create a Volume-Backed Instance using Juno and migrate it from one Compute Host to another.</p>

<p>First, my config; I’ve set up a multi-node deployment using devstack stable/juno.  I went ahead and configured Cinder to run multiple backends, in my case SolidFire and LVM because I wanted to test both and make sure everything worked properly.  For info on Cinder Multi-Backend checkout the wiki here: <a href="https://wiki.openstack.org/wiki/Cinder-multi-backend">Cinder multi-backend</a></p>

<p>I chose to specify ssh as my connection method for live-migration.  There are of course other ways to do this by configuring libvirt and qemu, which you can check out here: <a href="https://libvirt.org/uri.html">libvirt config</a> but rather than do any of that I just wanted to put a simple entry in my nova.conf file and use ssh.  Here’s the libvirt section of my nova.conf:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[libvirt]
inject_partition = -2
use_usb_tablet = False
cpu_mode = none
virt_type = kvm
live_migration_uri = qemu+ssh://root@%s/system
</code></pre>
</div>

<p>Notice I’m using root here in my connection.  I’ve used “regular” accounts with sudo permissions before to do remote connections to libvirt, but there’s something about the process from Nova that the Key Verification will fail for any user other than ‘root’.  If anybody knows how to fix this up let me know, It’d be great to learn what I’m missing here.  For those that are interested in more detail, my nova.conf other than the entry here is just the defaults from devstack.  Here’s a link to my nova.conf on the controller/compute: /etc/nova/nova.conf.  I’ve also added a link to my devstack local.conf; in this setup I actually started with a SolidFire deployment and manually updated cinder.conf to do multi-backend with LVM and added the default volume-type: devstack local.conf</p>

<p>So since we’re using ssh and root, you’ve probably guessed we’re going to need to setup ssh keys between our compute nodes.  I went ahead and setup root keys on each of the compute nodes, and installed each machines key on all of the nodes just doing a simple ssh-copy-id.  You may want to get a bit more sophisticated, distribute a key and modify /root/.ssh/config to include entries for each of the compute nodes.  Something like this should do the trick:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Host fluffy-compute
HostName fluffy-compute
User root
IdentityFile ~/.ssh/live-migrationkey.pem
</code></pre>
</div>

<p>Verify you can ssh as root to-&gt;from each of the Compute nodes, restart Nova Compute services and you <em>should</em> be ready to go.  Notice there I said <em>should</em>, what i found out was things didn’t work.  I’d get an error message stating that I couldn’t do live migration because I wasn’t using shared storage… huh?  What’s up with that?</p>

<p>So it turns out there was a bug introduced during the Juno development cycle.  You can check out the bug on LaunchPad here:<a href="https://bugs.launchpad.net/nova/+bug/1392773">LP-Bug</a></p>

<p>Fortunately there’s a proposal up for master already that can be pulled down (and hopefully will merge soon), but I was running Juno, so I put together a quick backport to try out.  Note this path isn’t quite complete, needs some method signature updates for the other hypervisors in OpenStack and of course Unit Tests.  Anyway, you can check out what I started via this <a href="https://gist.github.com/j-griffith/5e9be4e6548a03697dc5">gist</a></p>

<p>I went ahead an applied the Juno patch from the gist above, restarted all of my Nova services and tried again.  Here’s how things go:</p>

<p>First, grab the image-id you want to use and create a Cinder Volume with it…</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ubuntu@fluffy-master:~$ nova image-list
+--------------------------------------+---------------------------------+--------+--------+
| ID                                   | Name                            | Status | Server |
+--------------------------------------+---------------------------------+--------+--------+
| 40520350-25c7-4786-9586-5430d52d7663 | RedHat 6.5 Server               | ACTIVE |        |
| 8a69ae88-a729-4d68-a7e6-25048b1cf885 | RedHat 7.0 Server               | ACTIVE |        |
| afaa2feb-3a58-4e72-bebd-38f66bd0b611 | Ubuntu 14.04 Server             | ACTIVE |        |
| 28b77f27-a922-4627-8b1d-f0df627be907 | cirros-0.3.2-x86_64-uec         | ACTIVE |        |
| 63c173cd-3f5a-49ff-89ab-8c90a1701808 | cirros-0.3.2-x86_64-uec-kernel  | ACTIVE |        |
| e3aa2ab0-383c-4f75-bdc0-dbee86645ad5 | cirros-0.3.2-x86_64-uec-ramdisk | ACTIVE |        |
+--------------------------------------+---------------------------------+--------+--------+
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>ubuntu@fluffy-master:~$ cinder create --image-id \
afaa2feb-3a58-4e72-bebd-38f66bd0b611 --display-name trusty-volume 10
+---------------------------------------+--------------------------------------+
| Property                              | Value |
+---------------------------------------+--------------------------------------+
| attachments                           | []                                   |
| availability_zone                     | nova                                 |
| bootable                              | false                                |
| consistencygroup_id                   | None                                 |
| created_at                            | 2014-12-08T17:34:50.000000           |
| description                           | None                                 |
| encrypted                             | False                                |
| id                                    | 6419112b-bf40-4994-809f-12dce25f5f1f |
| metadata                              | {}                                   |
| name                                  | trusty-volume                        |
| os-vol-host-attr:host                 | None                                 |
| os-vol-mig-status-attr:migstat        | None                                 |
| os-vol-mig-status-attr:name_id        | None                                 |
| os-vol-tenant-attr:tenant_id          | 56dc791650074cc9a2858bd5053a7116     |
| os-volume-replication:driver_data     | None                                 |
| os-volume-replication:extended_status | None                                 |
| replication_status                    | disabled                             |
| size                                  | 10                                   |
| snapshot_id                           | None                                 |
| source_volid                          | None                                 |
| status                                | creating                             |
| user_id                               | 3dcc1572d7594a4eb6b043b819e415de     |
| volume_type                           | solidfire                            |
+---------------------------------------+--------------------------------------+
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>ubuntu@fluffy-master:~$cinder list
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+
| ID                                   | Status    | Name          | Size | Volume Type | Bootable | Attached to |
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+
| 6419112b-bf40-4994-809f-12dce25f5f1f | available | trusty-volume | 10   | solidfire   | true     |             |
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>ubuntu@fluffy-master:~$ nova boot --flavor 2 --block-device-mapping \
vda=6419112b-bf40-4994-809f-12dce25f5f1f --key-name fluffycloud trusty-migrate
+--------------------------------------+--------------------------------------------------+
| Property                             | Value                                            |
+--------------------------------------+--------------------------------------------------+
| OS-DCF:diskConfig                    | MANUAL                                           |
| OS-EXT-AZ:availability_zone          | nova                                             |
| OS-EXT-SRV-ATTR:host                 | -                                                |
| OS-EXT-SRV-ATTR:hypervisor_hostname  | -                                                |
| OS-EXT-SRV-ATTR:instance_name        | instance-00000002                                |
| OS-EXT-STS:power_state               | 0                                                |
| OS-EXT-STS:task_state                | scheduling                                       |
| OS-EXT-STS:vm_state                  | building                                         |
| OS-SRV-USG:launched_at               | -                                                |
| OS-SRV-USG:terminated_at             | -                                                |
| accessIPv4                           |                                                  |
| accessIPv6                           |                                                  |
| adminPass                            | rKL9sfs2vPs4                                     |
| config_drive                         |                                                  |
| created                              | 2014-12-08T17:41:39Z                             |
| flavor                               | m1.small (2)                                     |
| hostId                               |                                                  |
| id                                   | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904             |
| image                                | Attempt to boot from volume - no image supplied  |
| key_name                             | fluffycloud                                      |
| metadata                             | {}                                               |
| name                                 | trusty-migrate                                   |
| os-extended-volumes:volumes_attached | [{6419112b-bf40-4994-809f-12dce25f5f1f&amp;quot;}]   |
| progress                             | 0                                                |
| security_groups                      | default                                          |
| status                               | BUILD                                            |
| tenant_id                            | 56dc791650074cc9a2858bd5053a7116                 |
| updated                              | 2014-12-08T17:41:39Z                             |
| user_id                              | 3dcc1572d7594a4eb6b043b819e415de                 |
+--------------------------------------+--------------------------------------------------+
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>ubuntu@fluffy-master:~$ nova list
+--------------------------------------+----------------+--------+------------+-------------+------------------+
| ID                                   | Name           | Status | Task State | Power State | Networks         |
+--------------------------------------+----------------+--------+------------+-------------+------------------+
| 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | ACTIVE | -          | Running     | private=10.1.0.2 |
+--------------------------------------+----------------+--------+------------+-------------+------------------+
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>ubuntu@fluffy-master:~$ nova show 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904
+--------------------------------------+----------------------------------------------------------+
| Property                             | Value                                                    |
+--------------------------------------+----------------------------------------------------------+
| OS-DCF:diskConfig                    | MANUAL                                                   |
| OS-EXT-AZ:availability_zone          | nova                                                     |
| OS-EXT-SRV-ATTR:host                 | fluffy-compute                                           |
| OS-EXT-SRV-ATTR:hypervisor_hostname  | fluffy-compute                                           |
| OS-EXT-SRV-ATTR:instance_name        | instance-00000002                                        |
| OS-EXT-STS:power_state               | 1                                                        |
| OS-EXT-STS:task_state                | -                                                        |
| OS-EXT-STS:vm_state                  | active                                                   |
| OS-SRV-USG:launched_at               | 2014-12-08T17:41:47.000000                               |
| OS-SRV-USG:terminated_at             | -                                                        |
| accessIPv4                           |                                                          |
| accessIPv6                           |                                                          |
| config_drive                         |                                                          |
| created                              | 2014-12-08T17:41:39Z                                     |
| flavor                               | m1.small (2)                                             |
| hostId                               | 48adbabbab9babab4c8948d3478e9d2fae8ffb407bab1ca21a843981 |
| id                                   | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904                     |
| image                                | Attempt to boot from volume - no image supplied          |
| key_name                             | fluffycloud                                              |
| metadata                             | {}                                                       |
| name                                 | trusty-migrate                                           |
| os-extended-volumes:volumes_attached | [{6419112b-bf40-4994-809f-12dce25f5f1f;}]                |
| private network                      | 10.1.0.2                                                 |
| progress                             | 0                                                        |
| security_groups                      | default                                                  |
| status                               | ACTIVE                                                   |
| tenant_id                            | 56dc791650074cc9a2858bd5053a7116                         |
| updated                              | 2014-12-08T17:41:47Z                                     |
| user_id                              | 3dcc1572d7594a4eb6b043b819e415de                         |
+--------------------------------------+----------------------------------------------------------+
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>    ubuntu@fluffy-master:~$ubuntu@fluffy-master:~$ nova live-migration \
	9afb79e1-f07a-4c98-9d6c-9ce66dcbf904
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>    ubuntu@fluffy-master:~$ nova list
    +--------------------------------------+----------------+-----------+------------+-------------+------------------+
    | ID | Name | Status | Task State | Power State | Networks |
    +--------------------------------------+----------------+-----------+------------+-------------+------------------+
    | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | MIGRATING | migrating | Running | private=10.1.0.2 |
    +--------------------------------------+----------------+-----------+------------+-------------+------------------+
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>    ubuntu@fluffy-master:~$nova list
    +--------------------------------------+----------------+--------+------------+-------------+------------------+
    | ID | Name | Status | Task State | Power State | Networks |
    +--------------------------------------+----------------+--------+------------+-------------+------------------+
    | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | ACTIVE | - | Running | private=10.1.0.2 |
    +--------------------------------------+----------------+--------+------------+-------------+------------------+
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>    ubuntu@fluffy-master:~$ nova show 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904
    +--------------------------------------+----------------------------------------------------------+
    | Property                             | Value                                                    |
    +--------------------------------------+----------------------------------------------------------+
    | OS-DCF:diskConfig                    | MANUAL                                                   |
    | OS-EXT-AZ:availability_zone          | nova                                                     |
    | OS-EXT-SRV-ATTR:host                 | fluffy-master                                            |
    | OS-EXT-SRV-ATTR:hypervisor_hostname  | fluffy-master                                            |
    | OS-EXT-SRV-ATTR:instance_name        | instance-00000002                                        |
    | OS-EXT-STS:power_state               | 1                                                        |
    | OS-EXT-STS:task_state                | -                                                        |
    | OS-EXT-STS:vm_state                  | active                                                   |
    | OS-SRV-USG:launched_at               | 2014-12-08T17:41:47.000000                               |
    | OS-SRV-USG:terminated_at             | -                                                        |
    | accessIPv4                           |                                                          |
    | accessIPv6                           |                                                          |
    | config_drive                         |                                                          |
    | created                              | 2014-12-08T17:41:39Z                                     |
    | flavor                               | m1.small (2)                                             |
    | hostId                               | 97a1a99eaf8e1fab2ea7cb0be641ff55f2da5df4e68d0ecb62293e00 |
    | id                                   | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904                     |
    | image                                | Attempt to boot from volume - no image supplied          |
    | key_name                             | fluffycloud                                              |
    | metadata                             | {}                                                       |
    | name                                 | trusty-migrate                                           |
    | os-extended-volumes:volumes_attached | [{6419112b-bf40-4994-809f-12dce25f5f1f}]                 |
    | private network                      | 10.1.0.2                                                 |
    | progress                             | 0                                                        |
    | security_groups                      | default                                                  |
    | status                               | ACTIVE                                                   |
    | tenant_id                            | 56dc791650074cc9a2858bd5053a7116                         |
    | updated                              | 2014-12-08T17:41:47Z                                     |
    | user_id                              | 3dcc1572d7594a4eb6b043b819e415de                         |
    +--------------------------------------+----------------------------------------------------------+
</code></pre>
</div>

<p>Pretty cool eh?  As always feedback is more than welcome.  Also, if you have specific OpenStack / Cinder related topics you might want to see more about, drop me a line or post a comment.</p>

<p>Thanks!!!</p>


  </div><!-- /.entry-content -->
</article><!-- /.hentry -->



</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2016 John Griffith. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>



          

</body>
</html>