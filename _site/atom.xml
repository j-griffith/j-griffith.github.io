<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
 <title>John Griffith on github.io</title>
 <link href="http://username.github.io/atom.xml" rel="self"/>
 <link href="http://username.github.io"/>
 <updated>2015-07-17T16:38:16-06:00</updated>
 <id>http://username.github.io</id>
 <author>
   <name>John Griffith</name>
   <email>john.griffith8@gmail.com</email>
 </author>

 
 <entry>
   <title>Volume attach code flow in Cinder</title>
   <link href="http://username.github.io/2015/07/16/volume-attach-code-flow-in-cinder"/>
   <updated>2015-07-16T10:00:00-06:00</updated>
   <id>http://username.github.io/2015/07/16/volume-attach-code-flow-in-cinder</id>
   <content type="html">&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;header class=&quot;entry-header&quot; style=&quot;box-sizing: border-box; color: #444444; font-family: Merriweather, Georgia, &#39;Times New Roman&#39;, serif; font-size: 18px; line-height: 30px;&quot;&gt;&lt;h1 class=&quot;entry-title&quot; style=&quot;border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-size: 2.61111em; font-style: inherit; font-weight: inherit; line-height: 1.26383em; margin: 30px 0px; outline: 0px; padding: 0px; text-align: center; vertical-align: baseline;&quot;&gt;OpenStack Cinder – Volume Attach&amp;nbsp;flow&lt;/h1&gt;&lt;/header&gt;&lt;br /&gt;&lt;div class=&quot;entry-content&quot; style=&quot;border: 0px; box-sizing: border-box; font-family: Merriweather, Georgia, &#39;Times New Roman&#39;, serif; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;h2 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 29px; font-style: inherit; font-weight: inherit; line-height: 1.02414em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;Intro&lt;/span&gt;&lt;/h2&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;Something that comes up fairly often in IRC, is “how does attach work”? &amp;nbsp;From a Cinder perspective the code path is fairly simple, but it seems to throw people for a loop. &amp;nbsp;So, I figured why not take a look at the reference implementation and walk through the steps of volume attach from the Cinder side.&lt;/div&gt;&lt;h2 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 29px; font-style: inherit; font-weight: inherit; line-height: 1.02414em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;Our Reference&lt;/span&gt;&lt;/h2&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;The Cinder project includes a reference driver, so we’ll use that as our reference here to walk through the code. &amp;nbsp;The reference driver is built in Cinder using a combination of LVM and iSCSI targets (tgt-adm or LIO most commonly). &amp;nbsp;As with everything in OpenStack you have choices, we’re just going to focus on the default options here, thick provisioned LVM and TgtAdm for the iSCSI component. &amp;nbsp;We’re also using the default libvirt/KVM config on our Nova side.&lt;/div&gt;&lt;h2 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 29px; font-style: inherit; font-weight: inherit; line-height: 1.02414em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;A few high level details&lt;/span&gt;&lt;/h2&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;It’s important to understand that most of the work with respect to attaching a volume is done on the Nova side. &amp;nbsp;Cinder is mostly just responsible for providing a volumes information to Nova so that it can make an iSCSI attach on the Compute Node.&lt;/div&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;The communication path between Nova and Cinder is done via the cinderclient, the same cinderclient a command line user accesses; however Nova uses a special policy that allows it to access some details about a volume that regular users can’t, as well as a few calls you might not have seen before.&lt;/div&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;So what we’re going to do is look at an OpenStack deployment that has a volume ready to go (available) and an Instance that’s up and ready. &amp;nbsp;We’ll focus on the calls from Nova to Cinder and Cinders response. &amp;nbsp;In a follow up post we’ll dig into what’s happening on the Nova side.&lt;/div&gt;&lt;h2 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 29px; font-style: inherit; font-weight: inherit; line-height: 1.02414em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;Process flow&lt;/span&gt;&lt;/h2&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;As I mentioned, things on the Cinder side are rather simple. &amp;nbsp;The attach process is just&amp;nbsp;three&amp;nbsp;calls to Cinder:&lt;/div&gt;&lt;ol style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin: 0px 0px 30px 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;li style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;reserve_volume&lt;/li&gt;&lt;li style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;intialize_connection&lt;/li&gt;&lt;li style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;attach&lt;/li&gt;&lt;/ol&gt;&lt;h3 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 23px; font-style: inherit; font-weight: inherit; line-height: 1.2913em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;reserve_volume(self, context, volume)&lt;/span&gt;&lt;/h3&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;&quot;&gt;&lt;em style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;context: security/policy info for the request&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;em style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;volume: reference object of the volume being requested for reserve&lt;/span&gt;&lt;/em&gt;&lt;/div&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;Probably the most simple call&amp;nbsp;in to Cinder. &amp;nbsp;This method simply checks that the specified volume is in an “available” state and can be attached. &amp;nbsp;Any other state results in an Error response notifying Nova that the volume is NOT available. &amp;nbsp;The only valid state for this call to succeed is “available”.&lt;/div&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;If the volume is in fact available, we immediately issue an update to the Cinder database and mark the status of the volume to “attaching” thereby reserving the volume so that it won’t be used by another API call anywhere else.&lt;/div&gt;&lt;h3 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 23px; font-style: inherit; font-weight: inherit; line-height: 1.2913em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;initialize_connection(self, context, volume, connector)&lt;/span&gt;&lt;/h3&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;em style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;context: security/policy info for the request&lt;/em&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;em style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;volume: reference object of the volume being requested for reserve&lt;br style=&quot;box-sizing: border-box;&quot; /&gt;connector: information about the initiator if needed (ie targets that use access groups etc)&lt;/em&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;This is the only Cinder API method that really has any significant work to do, and it’s the only one that really has any real interaction with the storage backend or driver. &amp;nbsp;This method is responsible for building and returning all of the info needed by Nova to actually attach the specified volume. &amp;nbsp;This method returns vital information to the caller (Nova) that includes things like CHAP credentials, iqn and lun information. &amp;nbsp;An example response is shown here:&lt;br /&gt;&lt;br /&gt;&lt;/div&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;{‘driver_volume_type&#39;: ‘iscsi’,&lt;/span&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; ‘data&#39;: {‘auth_password&#39;: ‘YZ2Hceyh7VySh5HY’,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘target_discovered&#39;: False,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘encrypted&#39;: False,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘qos_specs&#39;: None,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘target_iqn&#39;: ‘iqn.2010-10.org.openstack:volume-8b1ec3fe-8c5&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘target_portal&#39;: ‘11.0.0.8:3260′,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘volume_id&#39;: ‘8b1ec3fe-8c57-45ca-a1cf-a481bfc8fce2′,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘target_lun&#39;: 1,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘access_mode&#39;: ‘rw’,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘auth_username&#39;: ‘nE9PY8juynmmZ95F7Xb7′,&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ‘auth_method&#39;: ‘CHAP’}}&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #666699; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;&quot;&gt;In the process of building this data structure, the Cinder manager makes a number of direct calls to the driver. &amp;nbsp;The manager itself has a single initialize_connection call of it&#39;s own, but ties together a number of driver calls from within that method. &amp;nbsp;&lt;span style=&quot;font-family: inherit; font-style: inherit; font-weight: inherit;&quot;&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;h3 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;font-size: small;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;driver.validate_connector&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;font-weight: normal;&quot;&gt; &amp;nbsp; &lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;line-height: 1.2913em;&quot;&gt;Simply verifies that the initiator data is included in the passed in&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;line-height: 24.1731357574463px;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;&lt;span style=&quot;font-family: inherit; font-style: inherit; line-height: 24.1731357574463px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;font-family: inherit; font-style: inherit; line-height: 1.2913em;&quot;&gt;connector (there are some drivers that utilize pieces of this connector&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; data, but in the case of the reference, it just verifies it&#39;s there).&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;div&gt;&lt;h3 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;font-size: small;&quot;&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;driver.create_export&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;font-weight: normal; line-height: 1.2913em;&quot;&gt;This is the target specific, persistent data associated with a volume.&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; This method is responsible for building an actual iSCSI target, and&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; providing the &quot;location&quot; and &quot;auth&quot; information which will be used to&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; form the response data in the parent request.&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; We call this infor the model_update and it&#39;s used to update vital target&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; information associated with the volume in the Cinder database.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;h3 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;font-size: small;&quot;&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;driver.intialize_connection&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: #ff6600; line-height: 1.2913em;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;font-weight: normal; line-height: 1.2913em;&quot;&gt;Now that we&#39;ve actually built a target and persisted the important&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; bits of information associated with it, we&#39;re ready to actually assign&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; the target to a volume and form the needed info to pass back out&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; to our caller. &amp;nbsp;This is where we finally put everything together and&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; form the example data structure response shown earlier.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;h3 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;font-size: small;&quot;&gt;&lt;span style=&quot;font-weight: normal; line-height: 1.2913em;&quot;&gt;&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; This method is sort of deceptive, it does a whole lot of formatting&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; of the data we&#39;ve put together in the create_export call, but it doesn&#39;t&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; really offer any new info. &amp;nbsp;It&#39;s completely dependent on the information&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; that was gathered in the create_export call and put into the database. &amp;nbsp;At&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; this point, all we&#39;re doing is taking all the various entries from the database&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; and putting it together into the desired format/structure.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/h3&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;div&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;font-size: small;&quot;&gt;&lt;span style=&quot;line-height: 1.2913em;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; The key method call for updating and obtaining all of this info was&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; done by the create_export call. &amp;nbsp;This formatted data is then passed&lt;br /&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; back up to the API and returned as the response back out to Nova.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;font-size: small;&quot;&gt;&lt;span style=&quot;line-height: 1.2913em;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;div&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;font-size: small;&quot;&gt;&lt;span style=&quot;line-height: 1.2913em;&quot;&gt;At this point Nova can use the returned info and actually make the iSCSI attach on the compute node, and then pass the volume into the requested Instance. &amp;nbsp;If there are no errors, the volume is now actually attached to the Instance as a /dev/vdX device and ready for use. &amp;nbsp;Remember however there was still one Cinder call left in our list: &amp;nbsp;attach.&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;font-size: small;&quot;&gt;&lt;span style=&quot;line-height: 1.2913em;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;h3 style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; clear: both; color: #444444; font-family: inherit; font-size: 23px; font-style: inherit; font-weight: inherit; line-height: 1.2913em; margin: 30px 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;attach(&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: #ff6600; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;self, context, volume,&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;color: #ff6600; font-style: inherit; font-weight: inherit;&quot;&gt;instance_uuid, host_name,&lt;br /&gt;mount_point, mode)&lt;/span&gt;&lt;/h3&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;em style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;context: security/policy info for the request&lt;/em&gt;&lt;/span&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;em style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;volume: reference object of the volume being requested for reserve&lt;br style=&quot;box-sizing: border-box;&quot; /&gt;instance_uuid: UUID of the Nova instance we&#39;ve attached to&lt;br /&gt;host_name: N/A for the reference driver&lt;br /&gt;mount_point: device mount point on the instance (/dev/vdb)&lt;br /&gt;mode: The attach mode of the Volume (rw, ro etc)&lt;/em&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;This is another method that falls into a category I call &quot;update methods&quot;. &amp;nbsp;It&#39;s purpose is to notify Cinder to update the status of the volume to &quot;in-use&quot; (attached) and to populate the database with the provided information regarding &quot;where&quot; it&#39;s attached to. &amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;span style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;&quot;&gt;This also provides a mechanism to send notifications and updates back to the driver. &amp;nbsp;&lt;/div&gt;&lt;div style=&quot;border-image-outset: initial; border-image-repeat: initial; border-image-slice: initial; border-image-source: initial; border-image-width: initial; border: 0px; box-sizing: border-box; color: #444444; font-family: inherit; font-size: 18px; font-style: inherit; font-weight: inherit; line-height: 30px; margin-bottom: 30px; outline: 0px; padding: 0px 0px 0px 30px; vertical-align: baseline;&quot;&gt;&lt;span style=&quot;border: 0px; box-sizing: border-box; color: grey; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;em style=&quot;border: 0px; box-sizing: border-box; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/em&gt;&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;</content>
 </entry>
 
 <entry>
   <title>OpenStack Live Migration With Cinder Backed Instances</title>
   <link href="http://username.github.io/2014/12/08/openstack-live-migration-with-cinder-backed-instances"/>
   <updated>2014-12-08T00:00:00-07:00</updated>
   <id>http://username.github.io/2014/12/08/openstack-live-migration-with-cinder-backed-instances</id>
   <content type="html">&lt;p&gt;&lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=utf-8&#39; /&gt;&lt;/p&gt;

&lt;p&gt;Over the last several weeks I keep getting questions about Live Migration, does it work, how do you configure it, what are the requirements to use it and so on.  To be honest up until recently I hadn’t actually dove into Live Migration so I tried it out (and failed), then started asking around and resorting to Google Searches.  The good thing is, there’s TONS of information out there, problem is, there’s TONS of information out there.  The bad thing here is the info isn’t all that consistent.  Like many things there’s always more than one way to achieve an end result, Live Migration is really no different.  So I thought I’d try and write up what worked for me and in my opinion was the simplest method to use.&lt;/p&gt;

&lt;p&gt;First off, for those that aren’t familiar; Live Migration of OpenStack Instances is the process of migrating an OpenStack Instance from one Compute Node to another with little or no downtime.  The docs page has a good description here: &lt;a href=&quot;http://docs.openstack.org/admin-guide-cloud/content/section_configuring-compute-migrations.html&quot;&gt;OpenStack Admin-Guide&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One of the big misconceptions about Live Migration is that if you’re Instances aren’t stored on a Shared FS or a Shared backend device like CEPH you can’t do Live-Migration.  That’s not true at all, in fact notice the doc has an entry specifically for Volume-Backed Instances.  So let’s take a look at how to create a Volume-Backed Instance using Juno and migrate it from one Compute Host to another.&lt;/p&gt;

&lt;p&gt;First, my config; I’ve set up a multi-node deployment using devstack stable/juno.  I went ahead and configured Cinder to run multiple backends, in my case SolidFire and LVM because I wanted to test both and make sure everything worked properly.  For info on Cinder Multi-Backend checkout the wiki here: &lt;a href=&quot;https://wiki.openstack.org/wiki/Cinder-multi-backend&quot;&gt;Cinder multi-backend&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I chose to specify ssh as my connection method for live-migration.  There are of course other ways to do this by configuring libvirt and qemu, which you can check out here: &lt;a href=&quot;https://libvirt.org/uri.html&quot;&gt;libvirt config&lt;/a&gt; but rather than do any of that I just wanted to put a simple entry in my nova.conf file and use ssh.  Here’s the libvirt section of my nova.conf:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;[libvirt]
inject_partition = -2
use_usb_tablet = False
cpu_mode = none
virt_type = kvm
live_migration_uri = qemu+ssh://root@%s/system
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Notice I’m using root here in my connection.  I’ve used “regular” accounts with sudo permissions before to do remote connections to libvirt, but there’s something about the process from Nova that the Key Verification will fail for any user other than ‘root’.  If anybody knows how to fix this up let me know, It’d be great to learn what I’m missing here.  For those that are interested in more detail, my nova.conf other than the entry here is just the defaults from devstack.  Here’s a link to my nova.conf on the controller/compute: /etc/nova/nova.conf.  I’ve also added a link to my devstack local.conf; in this setup I actually started with a SolidFire deployment and manually updated cinder.conf to do multi-backend with LVM and added the default volume-type: devstack local.conf&lt;/p&gt;

&lt;p&gt;So since we’re using ssh and root, you’ve probably guessed we’re going to need to setup ssh keys between our compute nodes.  I went ahead and setup root keys on each of the compute nodes, and installed each machines key on all of the nodes just doing a simple ssh-copy-id.  You may want to get a bit more sophisticated, distribute a key and modify /root/.ssh/config to include entries for each of the compute nodes.  Something like this should do the trick:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;Host fluffy-compute
HostName fluffy-compute
User root
IdentityFile ~/.ssh/live-migrationkey.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Verify you can ssh as root to-&amp;gt;from each of the Compute nodes, restart Nova Compute services and you &lt;em&gt;should&lt;/em&gt; be ready to go.  Notice there I said &lt;em&gt;should&lt;/em&gt;, what i found out was things didn’t work.  I’d get an error message stating that I couldn’t do live migration because I wasn’t using shared storage… huh?  What’s up with that?&lt;/p&gt;

&lt;p&gt;So it turns out there was a bug introduced during the Juno development cycle.  You can check out the bug on LaunchPad here:&lt;a href=&quot;https://bugs.launchpad.net/nova/+bug/1392773&quot;&gt;LP-Bug&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fortunately there’s a proposal up for master already that can be pulled down (and hopefully will merge soon), but I was running Juno, so I put together a quick backport to try out.  Note this path isn’t quite complete, needs some method signature updates for the other hypervisors in OpenStack and of course Unit Tests.  Anyway, you can check out what I started via this &lt;a href=&quot;https://gist.github.com/j-griffith/5e9be4e6548a03697dc5&quot;&gt;gist&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I went ahead an applied the Juno patch from the gist above, restarted all of my Nova services and tried again.  Here’s how things go:&lt;/p&gt;

&lt;p&gt;First, grab the image-id you want to use and create a Cinder Volume with it…&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;ubuntu@fluffy-master:~$ nova image-list
+--------------------------------------+---------------------------------+--------+--------+
| ID                                   | Name                            | Status | Server |
+--------------------------------------+---------------------------------+--------+--------+
| 40520350-25c7-4786-9586-5430d52d7663 | RedHat 6.5 Server               | ACTIVE |        |
| 8a69ae88-a729-4d68-a7e6-25048b1cf885 | RedHat 7.0 Server               | ACTIVE |        |
| afaa2feb-3a58-4e72-bebd-38f66bd0b611 | Ubuntu 14.04 Server             | ACTIVE |        |
| 28b77f27-a922-4627-8b1d-f0df627be907 | cirros-0.3.2-x86_64-uec         | ACTIVE |        |
| 63c173cd-3f5a-49ff-89ab-8c90a1701808 | cirros-0.3.2-x86_64-uec-kernel  | ACTIVE |        |
| e3aa2ab0-383c-4f75-bdc0-dbee86645ad5 | cirros-0.3.2-x86_64-uec-ramdisk | ACTIVE |        |
+--------------------------------------+---------------------------------+--------+--------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;ubuntu@fluffy-master:~$ cinder create --image-id afaa2feb-3a58-4e72-bebd-38f66bd0b611 --display-name trusty-volume 10
+---------------------------------------+--------------------------------------+
| Property                              | Value |
+---------------------------------------+--------------------------------------+
| attachments                           | []                                   |
| availability_zone                     | nova                                 |
| bootable                              | false                                |
| consistencygroup_id                   | None                                 |
| created_at                            | 2014-12-08T17:34:50.000000           |
| description                           | None                                 |
| encrypted                             | False                                |
| id                                    | 6419112b-bf40-4994-809f-12dce25f5f1f |
| metadata                              | {}                                   |
| name                                  | trusty-volume                        |
| os-vol-host-attr:host                 | None                                 |
| os-vol-mig-status-attr:migstat        | None                                 |
| os-vol-mig-status-attr:name_id        | None                                 |
| os-vol-tenant-attr:tenant_id          | 56dc791650074cc9a2858bd5053a7116     |
| os-volume-replication:driver_data     | None                                 |
| os-volume-replication:extended_status | None                                 |
| replication_status                    | disabled                             |
| size                                  | 10                                   |
| snapshot_id                           | None                                 |
| source_volid                          | None                                 |
| status                                | creating                             |
| user_id                               | 3dcc1572d7594a4eb6b043b819e415de     |
| volume_type                           | solidfire                            |
+---------------------------------------+--------------------------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;ubuntu@fluffy-master:~$cinder list
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+
| ID                                   | Status    | Name          | Size | Volume Type | Bootable | Attached to |
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+
| 6419112b-bf40-4994-809f-12dce25f5f1f | available | trusty-volume | 10   | solidfire   | true     |             |
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;ubuntu@fluffy-master:~$ nova boot --flavor 2 --block-device-mapping vda=6419112b-bf40-4994-809f-12dce25f5f1f --key-name fluffycloud trusty-migrate
+--------------------------------------+--------------------------------------------------+
| Property | Value |
+--------------------------------------+--------------------------------------------------+
| OS-DCF:diskConfig                    | MANUAL
| OS-EXT-AZ:availability_zone          | nova |
| OS-EXT-SRV-ATTR:host                 | - |
| OS-EXT-SRV-ATTR:hypervisor_hostname  | - |
| OS-EXT-SRV-ATTR:instance_name        | instance-00000002 |
| OS-EXT-STS:power_state               | 0 |
| OS-EXT-STS:task_state                | scheduling |
| OS-EXT-STS:vm_state                  | building |
| OS-SRV-USG:launched_at               | - |
| OS-SRV-USG:terminated_at             | - |
| accessIPv4                           | |
| accessIPv6                           | |
| adminPass                            | rKL9sfs2vPs4 |
| config_drive                         | |
| created                              | 2014-12-08T17:41:39Z |
| flavor                               | m1.small (2) |
| hostId                               | |
| id                                   | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 |
| image                                | Attempt to boot from volume - no image supplied |
| key_name                             | fluffycloud |
| metadata                             | {} |
| name                                 | trusty-migrate                |
| os-extended-volumes:volumes_attached | [{&amp;amp;quot;id&amp;amp;quot;: &amp;amp;quot;6419112b-bf40-4994-809f-12dce25f5f1f&amp;amp;quot;}] |
| progress                             | 0 |
| security_groups                      | default |
| status                               | BUILD |
| tenant_id                            | 56dc791650074cc9a2858bd5053a7116 |
| updated                              | 2014-12-08T17:41:39Z |
| user_id                              | 3dcc1572d7594a4eb6b043b819e415de |
+--------------------------------------+--------------------------------------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;ubuntu@fluffy-master:~$ nova list
+--------------------------------------+----------------+--------+------------+-------------+------------------+
| ID | Name | Status | Task State | Power State | Networks |
+--------------------------------------+----------------+--------+------------+-------------+------------------+
| 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | ACTIVE | - | Running | private=10.1.0.2 |
+--------------------------------------+----------------+--------+------------+-------------+------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;ubuntu@fluffy-master:~$ nova show 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904
+--------------------------------------+----------------------------------------------------------+
| Property | Value |
+--------------------------------------+----------------------------------------------------------+
| OS-DCF:diskConfig | MANUAL |
| OS-EXT-AZ:availability_zone | nova |
| OS-EXT-SRV-ATTR:host | fluffy-compute |
| OS-EXT-SRV-ATTR:hypervisor_hostname | fluffy-compute |
| OS-EXT-SRV-ATTR:instance_name | instance-00000002 |
| OS-EXT-STS:power_state | 1 |
| OS-EXT-STS:task_state | - |
| OS-EXT-STS:vm_state | active |
| OS-SRV-USG:launched_at | 2014-12-08T17:41:47.000000 |
| OS-SRV-USG:terminated_at | - |
| accessIPv4 | |
| accessIPv6 | |
| config_drive | |
| created | 2014-12-08T17:41:39Z |
| flavor | m1.small (2) |
| hostId | 48adbabbab9babab4c8948d3478e9d2fae8ffb407bab1ca21a843981 |
| id | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 |
| image | Attempt to boot from volume - no image supplied |
| key_name | fluffycloud |
| metadata | {} |
| name | trusty-migrate |
| os-extended-volumes:volumes_attached | [{&amp;amp;quot;id&amp;amp;quot;: &amp;amp;quot;6419112b-bf40-4994-809f-12dce25f5f1f&amp;amp;quot;}] |
| private network | 10.1.0.2 |
| progress | 0 |
| security_groups | default |
| status | ACTIVE |
| tenant_id | 56dc791650074cc9a2858bd5053a7116 |
| updated | 2014-12-08T17:41:47Z |
| user_id | 3dcc1572d7594a4eb6b043b819e415de |
+--------------------------------------+----------------------------------------------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;    ubuntu@fluffy-master:~$ubuntu@fluffy-master:~$ nova live-migration 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;    ubuntu@fluffy-master:~$ nova list
    +--------------------------------------+----------------+-----------+------------+-------------+------------------+
    | ID | Name | Status | Task State | Power State | Networks |
    +--------------------------------------+----------------+-----------+------------+-------------+------------------+
    | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | MIGRATING | migrating | Running | private=10.1.0.2 |
    +--------------------------------------+----------------+-----------+------------+-------------+------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;    ubuntu@fluffy-master:~$nova list
    +--------------------------------------+----------------+--------+------------+-------------+------------------+
    | ID | Name | Status | Task State | Power State | Networks |
    +--------------------------------------+----------------+--------+------------+-------------+------------------+
    | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | ACTIVE | - | Running | private=10.1.0.2 |
    +--------------------------------------+----------------+--------+------------+-------------+------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;    ubuntu@fluffy-master:~$ nova show 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904
    +--------------------------------------+----------------------------------------------------------+
    | Property | Value |
    +--------------------------------------+----------------------------------------------------------+
    | OS-DCF:diskConfig | MANUAL |
    | OS-EXT-AZ:availability_zone | nova |
    | OS-EXT-SRV-ATTR:host | fluffy-master |
    | OS-EXT-SRV-ATTR:hypervisor_hostname | fluffy-master |
    | OS-EXT-SRV-ATTR:instance_name | instance-00000002 |
    | OS-EXT-STS:power_state | 1 |
    | OS-EXT-STS:task_state | - |
    | OS-EXT-STS:vm_state | active |
    | OS-SRV-USG:launched_at | 2014-12-08T17:41:47.000000 |
    | OS-SRV-USG:terminated_at | - |
    | accessIPv4 | |
    | accessIPv6 | |
    | config_drive | |
    | created | 2014-12-08T17:41:39Z |
    | flavor | m1.small (2) |
    | hostId | 97a1a99eaf8e1fab2ea7cb0be641ff55f2da5df4e68d0ecb62293e00 |
    | id | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 |
    | image | Attempt to boot from volume - no image supplied |
    | key_name | fluffycloud |
    | metadata | {} |
    | name | trusty-migrate |
    | os-extended-volumes:volumes_attached | [{&amp;amp;quot;id&amp;amp;quot;: &amp;amp;quot;6419112b-bf40-4994-809f-12dce25f5f1f&amp;amp;quot;}] |
    | private network | 10.1.0.2 |
    | progress | 0 |
    | security_groups | default |
    | status | ACTIVE |
    | tenant_id | 56dc791650074cc9a2858bd5053a7116 |
    | updated | 2014-12-08T17:41:47Z |
    | user_id | 3dcc1572d7594a4eb6b043b819e415de |
    +--------------------------------------+----------------------------------------------------------+
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Pretty cool eh?  As always feedback is more than welcome.  Also, if you have specific OpenStack / Cinder related topics you might want to see more about, drop me a line or post a comment.&lt;/p&gt;

&lt;p&gt;Thanks!!!&lt;/p&gt;
</content>
 </entry>
 
 
</feed>
