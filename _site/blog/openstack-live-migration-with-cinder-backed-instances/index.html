<!DOCTYPE html>
<html class="fuelux" lang="en">
  <head>
    <meta charset="utf-8">
    <title>OpenStack Live Migration With Cinder Backed Instances</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="http://fuelcdn.com/fuelux/2.2/css/fuelux.css" rel="stylesheet" /> 
	<link href="http://fuelcdn.com/fuelux/2.2/css/fuelux-responsive.css" rel="stylesheet" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	<script src="http://fuelcdn.com/fuelux/2.2/loader.min.js" type="text/javascript"></script>
    <link href="/css/docs.css" rel="stylesheet">
    <link href="/js/google-code-prettify/prettify.css" rel="stylesheet">	
	<link rel="shortcut icon" href="/favicon.ico">    
  </head>
  <body data-spy="scroll" data-target=".subnav" data-offset="50">
	<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
	<div class="container">
	  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
	  </a>
	  <a class="brand" href="http://j-griffith.github.com">My blog posts</a>
	  <div class="nav-collapse">
		<ul class="nav">
		  <li class="">
			<a href="http://j-griffith.github.com"><i class="icon-home"></i> Home</a>
		  </li>
		  <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-comment"></i> Social <b class="caret"></b></a>
				<ul class="dropdown-menu">
					<li class=""><a href="http://www.twitter.com/jdg_8" rel="tooltip" title="Go to twitter.com/jdg_8" target="_blank">Twitter</a></li>
					<li class=""><a href="http://github.com/j-griffith" rel="tooltip" title="Go to github.com/j-griffith" target="_blank">GitHub</a></li>
					<li class="divider"></li>
				</ul>
			 </li>
		<li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-list"></i> Projects <b class="caret"></b></a>
				<ul class="dropdown-menu">
				</ul>
			 </li>
		</ul>
	  </div>
	</div>
  </div>
</div>
  
	<div class="container">	
		<div class="marketing">
		<div class="content">    
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'ericjones'; // required: replace example with your forum shortname
		var disqus_identifier = '/blog/openstack-live-migration-with-cinder-backed-instances';
		var disqus_url = 'http://erjjones.github.com/blog/openstack-live-migration-with-cinder-backed-instances';

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>
	
<div class="row">	
	<div class="span9 column">
		<p><h1>OpenStack Live Migration With Cinder Backed Instances</h1></p>	
	</div>
</div>		
<div class="row">	
	<div class="span3 column">
		<h5><strong>December  8, 2014 <small>.  . <a href="http://erjjones.github.com/blog/openstack-live-migration-with-cinder-backed-instances#disqus_thread" data-disqus-identifier="/blog/openstack-live-migration-with-cinder-backed-instances">Comments</a></small></strong>
		<br/><small>Tags:  </small><br/><br/>
		<a href="https://twitter.com/share" class="twitter-share-button" data-via="erjjones">Tweet</a> <g:plusone size="medium"></g:plusone></h5>
	</div>		
	<div class="span6 column">
		<p class="pull-right"> <a href="/blog/remember-the-whole-point" title="Previous Post: Remember the whole point"><i class="icon-chevron-left"></i></a> 	    </p>  
	</div>	
</div>
<div class="row">
	<div class="span9 column">
		<hr>
	</div>
</div>


    <p>Over the last several weeks I keep getting questions about Live Migration, does it work, how do you configure it, what are the requirements to use it and so on.  To be honest up until recently I hadn't actually dove into Live Migration so I tried it out (and failed), then started asking around and resorting to Google Searches.  The good thing is, there's TONS of information out there, problem is, there's TONS of information out there.  The bad thing here is the info isn't all that consistent.  Like many things there's always more than one way to achieve an end result, Live Migration is really no different.  So I thought I'd try and write up what worked for me and in my opinion was the simplest method to use.</p>
<p>First off, for those that aren't familiar; Live Migration of OpenStack Instances is the process of migrating an OpenStack Instance from one Compute Node to another with little or no downtime.  The docs page has a good description here: http://docs.openstack.org/admin-guide-cloud/content/section_configuring-compute-migrations.html</p>
<p>One of the big misconceptions about Live Migration is that if you're Instances aren't stored on a Shared FS or a Shared backend device like CEPH you can't do Live-Migration.  That's not true at all, in fact notice the doc has an entry specifically for Volume-Backed Instances.  So let's take a look at how to create a Volume-Backed Instance using Juno and migrate it from one Compute Host to another.</p>
<p>First, my config; I've set up a multi-node deployment using devstack stable/juno.  I went ahead and configured Cinder to run multiple backends, in my case SolidFire and LVM because I wanted to test both and make sure everything worked properly.  For info on Cinder Multi-Backend checkout the wiki here: https://wiki.openstack.org/wiki/Cinder-multi-backend</p>
<p>I chose to specify ssh as my connection method for live-migration.  There are of course other ways to do this by configuring libvirt and qemu, which you can check out here: https://libvirt.org/uri.html but rather than do any of that I just wanted to put a simple entry in my nova.conf file and use ssh.  Here's the libvirt section of my nova.conf:</p>
<p>[code language="text"]</p>
<p>[libvirt]<br />
inject_partition = -2<br />
use_usb_tablet = False<br />
cpu_mode = none<br />
virt_type = kvm<br />
live_migration_uri = qemu+ssh://root@%s/system</p>
<p>[/code]</p>
<p>Notice I'm using root here in my connection.  I've used "regular" accounts with sudo permissions before to do remote connections to libvirt, but there's something about the process from Nova that the Key Verification will fail for any user other than 'root'.  If anybody knows how to fix this up let me know, It'd be great to learn what I'm missing here.  For those that are interested in more detail, my nova.conf other than the entry here is just the defaults from devstack.  Here's a link to my nova.conf on the controller/compute: <a title="/etc/nova/nova.conf" href="http://goo.gl/Z9br22" target="_blank">/etc/nova/nova.conf</a>.  I've also added a link to my devstack local.conf; in this setup I actually started with a SolidFire deployment and manually updated cinder.conf to do multi-backend with LVM and added the default volume-type: <a title="devstack/local.conf" href="http://goo.gl/MkVl1y" target="_blank">devstack local.conf</a></p>
<p>So since we're using ssh and root, you've probably guessed we're going to need to setup ssh keys between our compute nodes.  I went ahead and setup root keys on each of the compute nodes, and installed each machines key on all of the nodes just doing a simple ssh-copy-id.  You may want to get a bit more sophisticated, distribute a key and modify /root/.ssh/config to include entries for each of the compute nodes.  Something like this should do the trick:</p>
<p>[code language="text"]</p>
<p>Host fluffy-compute<br />
HostName fluffy-compute<br />
User root<br />
IdentityFile ~/.ssh/live-migrationkey.pem</p>
<p>[/code]</p>
<p>Verify you can ssh as root to-&gt;from each of the Compute nodes, restart Nova Compute services and you *should* be ready to go.  Notice there I said *should*, what i found out was things didn't work.  I'd get an error message stating that I couldn't do live migration because I wasn't using shared storage... huh?  What's up with that?</p>
<p>So it turns out there was a bug introduced during the Juno development cycle.  You can check out the bug on LaunchPad here: https://bugs.launchpad.net/nova/+bug/1392773</p>
<p>Fortunately there's a proposal up for master already that can be pulled down (and hopefully will merge soon), but I was running Juno, so I put together a quick backport to try out.  Note this path isn't quite complete, needs some method signature updates for the other hypervisors in OpenStack and of course Unit Tests.  Anyway, you can check out what I started via this gist: <a href="https://gist.github.com/j-griffith/5e9be4e6548a03697dc5" target="_blank">https://gist.github.com/j-griffith/5e9be4e6548a03697dc5</a></p>
<p>I went ahead an applied the Juno patch from the gist above, restarted all of my Nova services and tried again.  Here's how things go:</p>
<p>First, grab the image-id you want to use and create a Cinder Volume with it...</p>
<p>[code language="text"]</p>
<p>ubuntu@fluffy-master:~$ nova image-list<br />
+--------------------------------------+---------------------------------+--------+--------+<br />
| ID | Name | Status | Server |<br />
+--------------------------------------+---------------------------------+--------+--------+<br />
| 40520350-25c7-4786-9586-5430d52d7663 | RedHat 6.5 Server | ACTIVE | |<br />
| 8a69ae88-a729-4d68-a7e6-25048b1cf885 | RedHat 7.0 Server | ACTIVE | |<br />
| afaa2feb-3a58-4e72-bebd-38f66bd0b611 | Ubuntu 14.04 Server | ACTIVE | |<br />
| 28b77f27-a922-4627-8b1d-f0df627be907 | cirros-0.3.2-x86_64-uec | ACTIVE | |<br />
| 63c173cd-3f5a-49ff-89ab-8c90a1701808 | cirros-0.3.2-x86_64-uec-kernel | ACTIVE | |<br />
| e3aa2ab0-383c-4f75-bdc0-dbee86645ad5 | cirros-0.3.2-x86_64-uec-ramdisk | ACTIVE | |<br />
+--------------------------------------+---------------------------------+--------+--------+</p>
<p>ubuntu@fluffy-master:~$ cinder create --image-id afaa2feb-3a58-4e72-bebd-38f66bd0b611 --display-name trusty-volume 10<br />
+---------------------------------------+--------------------------------------+<br />
| Property | Value |<br />
+---------------------------------------+--------------------------------------+<br />
| attachments | [] |<br />
| availability_zone | nova |<br />
| bootable | false |<br />
| consistencygroup_id | None |<br />
| created_at | 2014-12-08T17:34:50.000000 |<br />
| description | None |<br />
| encrypted | False |<br />
| id | 6419112b-bf40-4994-809f-12dce25f5f1f |<br />
| metadata | {} |<br />
| name | trusty-volume |<br />
| os-vol-host-attr:host | None |<br />
| os-vol-mig-status-attr:migstat | None |<br />
| os-vol-mig-status-attr:name_id | None |<br />
| os-vol-tenant-attr:tenant_id | 56dc791650074cc9a2858bd5053a7116 |<br />
| os-volume-replication:driver_data | None |<br />
| os-volume-replication:extended_status | None |<br />
| replication_status | disabled |<br />
| size | 10 |<br />
| snapshot_id | None |<br />
| source_volid | None |<br />
| status | creating |<br />
| user_id | 3dcc1572d7594a4eb6b043b819e415de |<br />
| volume_type | solidfire |<br />
+---------------------------------------+--------------------------------------+</p>
<p>ubuntu@fluffy-master:~$cinder list<br />
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+<br />
| ID | Status | Name | Size | Volume Type | Bootable | Attached to |<br />
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+<br />
| 6419112b-bf40-4994-809f-12dce25f5f1f | available | trusty-volume | 10 | solidfire | true | |<br />
+--------------------------------------+-----------+---------------+------+-------------+----------+-------------+</p>
<p>ubuntu@fluffy-master:~$ nova boot --flavor 2 --block-device-mapping vda=6419112b-bf40-4994-809f-12dce25f5f1f --key-name fluffycloud trusty-migrate<br />
+--------------------------------------+--------------------------------------------------+<br />
| Property | Value |<br />
+--------------------------------------+--------------------------------------------------+<br />
| OS-DCF:diskConfig | MANUAL |<br />
| OS-EXT-AZ:availability_zone | nova |<br />
| OS-EXT-SRV-ATTR:host | - |<br />
| OS-EXT-SRV-ATTR:hypervisor_hostname | - |<br />
| OS-EXT-SRV-ATTR:instance_name | instance-00000002 |<br />
| OS-EXT-STS:power_state | 0 |<br />
| OS-EXT-STS:task_state | scheduling |<br />
| OS-EXT-STS:vm_state | building |<br />
| OS-SRV-USG:launched_at | - |<br />
| OS-SRV-USG:terminated_at | - |<br />
| accessIPv4 | |<br />
| accessIPv6 | |<br />
| adminPass | rKL9sfs2vPs4 |<br />
| config_drive | |<br />
| created | 2014-12-08T17:41:39Z |<br />
| flavor | m1.small (2) |<br />
| hostId | |<br />
| id | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 |<br />
| image | Attempt to boot from volume - no image supplied |<br />
| key_name | fluffycloud |<br />
| metadata | {} |<br />
| name | trusty-migrate |<br />
| os-extended-volumes:volumes_attached | [{&amp;quot;id&amp;quot;: &amp;quot;6419112b-bf40-4994-809f-12dce25f5f1f&amp;quot;}] |<br />
| progress | 0 |<br />
| security_groups | default |<br />
| status | BUILD |<br />
| tenant_id | 56dc791650074cc9a2858bd5053a7116 |<br />
| updated | 2014-12-08T17:41:39Z |<br />
| user_id | 3dcc1572d7594a4eb6b043b819e415de |<br />
+--------------------------------------+--------------------------------------------------+</p>
<p>ubuntu@fluffy-master:~$ nova list<br />
+--------------------------------------+----------------+--------+------------+-------------+------------------+<br />
| ID | Name | Status | Task State | Power State | Networks |<br />
+--------------------------------------+----------------+--------+------------+-------------+------------------+<br />
| 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | ACTIVE | - | Running | private=10.1.0.2 |<br />
+--------------------------------------+----------------+--------+------------+-------------+------------------+</p>
<p>ubuntu@fluffy-master:~$ nova show 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904<br />
+--------------------------------------+----------------------------------------------------------+<br />
| Property | Value |<br />
+--------------------------------------+----------------------------------------------------------+<br />
| OS-DCF:diskConfig | MANUAL |<br />
| OS-EXT-AZ:availability_zone | nova |<br />
| OS-EXT-SRV-ATTR:host | fluffy-compute |<br />
| OS-EXT-SRV-ATTR:hypervisor_hostname | fluffy-compute |<br />
| OS-EXT-SRV-ATTR:instance_name | instance-00000002 |<br />
| OS-EXT-STS:power_state | 1 |<br />
| OS-EXT-STS:task_state | - |<br />
| OS-EXT-STS:vm_state | active |<br />
| OS-SRV-USG:launched_at | 2014-12-08T17:41:47.000000 |<br />
| OS-SRV-USG:terminated_at | - |<br />
| accessIPv4 | |<br />
| accessIPv6 | |<br />
| config_drive | |<br />
| created | 2014-12-08T17:41:39Z |<br />
| flavor | m1.small (2) |<br />
| hostId | 48adbabbab9babab4c8948d3478e9d2fae8ffb407bab1ca21a843981 |<br />
| id | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 |<br />
| image | Attempt to boot from volume - no image supplied |<br />
| key_name | fluffycloud |<br />
| metadata | {} |<br />
| name | trusty-migrate |<br />
| os-extended-volumes:volumes_attached | [{&amp;quot;id&amp;quot;: &amp;quot;6419112b-bf40-4994-809f-12dce25f5f1f&amp;quot;}] |<br />
| private network | 10.1.0.2 |<br />
| progress | 0 |<br />
| security_groups | default |<br />
| status | ACTIVE |<br />
| tenant_id | 56dc791650074cc9a2858bd5053a7116 |<br />
| updated | 2014-12-08T17:41:47Z |<br />
| user_id | 3dcc1572d7594a4eb6b043b819e415de |<br />
+--------------------------------------+----------------------------------------------------------+</p>
<p>ubuntu@fluffy-master:~$ubuntu@fluffy-master:~$ nova live-migration 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904<br />
ubuntu@fluffy-master:~$ nova list<br />
+--------------------------------------+----------------+-----------+------------+-------------+------------------+<br />
| ID | Name | Status | Task State | Power State | Networks |<br />
+--------------------------------------+----------------+-----------+------------+-------------+------------------+<br />
| 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | MIGRATING | migrating | Running | private=10.1.0.2 |<br />
+--------------------------------------+----------------+-----------+------------+-------------+------------------+</p>
<p>ubuntu@fluffy-master:~$nova list<br />
+--------------------------------------+----------------+--------+------------+-------------+------------------+<br />
| ID | Name | Status | Task State | Power State | Networks |<br />
+--------------------------------------+----------------+--------+------------+-------------+------------------+<br />
| 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 | trusty-migrate | ACTIVE | - | Running | private=10.1.0.2 |<br />
+--------------------------------------+----------------+--------+------------+-------------+------------------+</p>
<p>ubuntu@fluffy-master:~$ nova show 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904<br />
+--------------------------------------+----------------------------------------------------------+<br />
| Property | Value |<br />
+--------------------------------------+----------------------------------------------------------+<br />
| OS-DCF:diskConfig | MANUAL |<br />
| OS-EXT-AZ:availability_zone | nova |<br />
| OS-EXT-SRV-ATTR:host | fluffy-master |<br />
| OS-EXT-SRV-ATTR:hypervisor_hostname | fluffy-master |<br />
| OS-EXT-SRV-ATTR:instance_name | instance-00000002 |<br />
| OS-EXT-STS:power_state | 1 |<br />
| OS-EXT-STS:task_state | - |<br />
| OS-EXT-STS:vm_state | active |<br />
| OS-SRV-USG:launched_at | 2014-12-08T17:41:47.000000 |<br />
| OS-SRV-USG:terminated_at | - |<br />
| accessIPv4 | |<br />
| accessIPv6 | |<br />
| config_drive | |<br />
| created | 2014-12-08T17:41:39Z |<br />
| flavor | m1.small (2) |<br />
| hostId | 97a1a99eaf8e1fab2ea7cb0be641ff55f2da5df4e68d0ecb62293e00 |<br />
| id | 9afb79e1-f07a-4c98-9d6c-9ce66dcbf904 |<br />
| image | Attempt to boot from volume - no image supplied |<br />
| key_name | fluffycloud |<br />
| metadata | {} |<br />
| name | trusty-migrate |<br />
| os-extended-volumes:volumes_attached | [{&amp;quot;id&amp;quot;: &amp;quot;6419112b-bf40-4994-809f-12dce25f5f1f&amp;quot;}] |<br />
| private network | 10.1.0.2 |<br />
| progress | 0 |<br />
| security_groups | default |<br />
| status | ACTIVE |<br />
| tenant_id | 56dc791650074cc9a2858bd5053a7116 |<br />
| updated | 2014-12-08T17:41:47Z |<br />
| user_id | 3dcc1572d7594a4eb6b043b819e415de |<br />
+--------------------------------------+----------------------------------------------------------+<br />
[/code]</p>
<p>Pretty cool eh?  As always feedback is more than welcome.  Also, if you have specific OpenStack / Cinder related topics you might want to see more about, drop me a line or post a comment.</p>
<p>Thanks!!!</p>
		
</div>
    

		</div>		 
	 </div>   
	<footer class="footer">
  <div class="container">
	<p class="pull-right"> <a href="/blog/remember-the-whole-point" title="Previous Post: Remember the whole point">&laquo; Previous Blog Post</a> 	  |  <a href="#">Back to top</a>  |   </p>
	<p>Page last generated on July 16, 2015</p>
	<p>If need be, <a href="https://github.com/j-griffith/Feedback/issues/new" title="Leave feedback for John"  target="_blank" >leave me some feedback</a>.</p>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </div>
</footer>

    <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>    
    
	<script src="/js/custom.js" type="text/javascript"></script>	
	
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'ericjones'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>
	
	<!-- Google Analytics -->
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-29830549-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>	
  </body>
</html>
